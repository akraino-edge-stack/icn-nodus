apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: networkchainings.k8s.plugin.opnfv.org
spec:
  group: k8s.plugin.opnfv.org
  names:
    kind: NetworkChaining
    listKind: NetworkChainingList
    plural: networkchainings
    singular: networkchaining
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: NetworkChaining is the Schema for the networkchainings API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: NetworkChainingSpec defines the desired state of NetworkChaining
            properties:
              chainType:
                type: string
              routingSpec:
                properties:
                  left:
                    items:
                      properties:
                        gatewayIp:
                          type: string
                        namespaceSelector:
                          properties:
                            matchExpressions:
                              items:
                                properties:
                                  key:
                                    type: string
                                  operator:
                                    enum:
                                    - In
                                    - NotIn
                                    - Exists
                                    - DoesNotExist
                                    type: string
                                  values:
                                    items:
                                      pattern: ^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?$
                                      type: string
                                    type: array
                                type: object
                              type: array
                            matchLabels:
                              x-kubernetes-preserve-unknown-fields: true
                          type: object
                        networkName:
                          type: string
                        podSelector:
                          properties:
                            matchExpressions:
                              items:
                                properties:
                                  key:
                                    type: string
                                  operator:
                                    enum:
                                    - In
                                    - NotIn
                                    - Exists
                                    - DoesNotExist
                                    type: string
                                  values:
                                    items:
                                      pattern: ^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?$
                                      type: string
                                    type: array
                                type: object
                              type: array
                            matchLabels:
                              x-kubernetes-preserve-unknown-fields: true
                          type: object
                        subnet:
                          type: string
                      required:
                      - gatewayIp
                      - networkName
                      type: object
                    type: array
                  namespace:
                    type: string
                  networkChain:
                    type: string
                  right:
                    items:
                      properties:
                        gatewayIp:
                          type: string
                        namespaceSelector:
                          properties:
                            matchExpressions:
                              items:
                                properties:
                                  key:
                                    type: string
                                  operator:
                                    enum:
                                    - In
                                    - NotIn
                                    - Exists
                                    - DoesNotExist
                                    type: string
                                  values:
                                    items:
                                      pattern: ^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?$
                                      type: string
                                    type: array
                                type: object
                              type: array
                            matchLabels:
                              x-kubernetes-preserve-unknown-fields: true
                          type: object
                        networkName:
                          type: string
                        podSelector:
                          properties:
                            matchExpressions:
                              items:
                                properties:
                                  key:
                                    type: string
                                  operator:
                                    enum:
                                    - In
                                    - NotIn
                                    - Exists
                                    - DoesNotExist
                                    type: string
                                  values:
                                    items:
                                      pattern: ^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?$
                                      type: string
                                    type: array
                                type: object
                              type: array
                            matchLabels:
                              x-kubernetes-preserve-unknown-fields: true
                          type: object
                        subnet:
                          type: string
                      required:
                      - gatewayIp
                      - networkName
                      type: object
                    type: array
                required:
                - left
                - namespace
                - networkChain
                - right
                type: object
            required:
            - chainType
            - routingSpec
            type: object
          status:
            description: NetworkChainingStatus defines the observed state of NetworkChaining
            properties:
              state:
                type: string
            required:
            - state
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: networks.k8s.plugin.opnfv.org
spec:
  group: k8s.plugin.opnfv.org
  names:
    kind: Network
    listKind: NetworkList
    plural: networks
    singular: network
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            properties:
              cniType:
                description: 'INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
                  Important: Run "operator-sdk generate k8s" to regenerate code after
                  modifying this file Add custom validation using kubebuilder tags:
                  https://book-v1.book.kubebuilder.io/beyond_basics/generating_crd.html'
                type: string
              dns:
                properties:
                  domain:
                    type: string
                  nameservers:
                    items:
                      type: string
                    type: array
                  options:
                    items:
                      type: string
                    type: array
                  search:
                    items:
                      type: string
                    type: array
                type: object
              ipv4Subnets:
                items:
                  properties:
                    excludeIps:
                      type: string
                    gateway:
                      type: string
                    name:
                      type: string
                    subnet:
                      type: string
                  required:
                  - name
                  - subnet
                  type: object
                type: array
              ipv6Subnets:
                items:
                  properties:
                    excludeIps:
                      type: string
                    gateway:
                      type: string
                    name:
                      type: string
                    subnet:
                      type: string
                  required:
                  - name
                  - subnet
                  type: object
                type: array
              routes:
                items:
                  properties:
                    dst:
                      type: string
                    gw:
                      type: string
                  required:
                  - dst
                  type: object
                type: array
            required:
            - cniType
            - ipv4Subnets
            type: object
          status:
            properties:
              state:
                description: 'INSERT ADDITIONAL STATUS FIELD - define observed state
                  of cluster Important: Run "operator-sdk generate k8s" to regenerate
                  code after modifying this file Add custom validation using kubebuilder
                  tags: https://book-v1.book.kubebuilder.io/beyond_basics/generating_crd.html'
                type: string
            required:
            - state
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: providernetworks.k8s.plugin.opnfv.org
spec:
  group: k8s.plugin.opnfv.org
  names:
    kind: ProviderNetwork
    listKind: ProviderNetworkList
    plural: providernetworks
    singular: providernetwork
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: ProviderNetwork is the Schema for the providernetworks API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: ProviderNetworkSpec defines the desired state of ProviderNetwork
            properties:
              cniType:
                description: 'INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
                  Important: Run "operator-sdk generate k8s" to regenerate code after
                  modifying this file Add custom validation using kubebuilder tags:
                  https://book-v1.book.kubebuilder.io/beyond_basics/generating_crd.html'
                type: string
              direct:
                properties:
                  directNodeSelector:
                    type: string
                  nodeLabelList:
                    items:
                      type: string
                    type: array
                  providerInterfaceName:
                    type: string
                required:
                - directNodeSelector
                - providerInterfaceName
                type: object
              dns:
                properties:
                  domain:
                    type: string
                  nameservers:
                    items:
                      type: string
                    type: array
                  options:
                    items:
                      type: string
                    type: array
                  search:
                    items:
                      type: string
                    type: array
                type: object
              ipv4Subnets:
                items:
                  properties:
                    excludeIps:
                      type: string
                    gateway:
                      type: string
                    name:
                      type: string
                    subnet:
                      type: string
                  required:
                  - name
                  - subnet
                  type: object
                type: array
              ipv6Subnets:
                items:
                  properties:
                    excludeIps:
                      type: string
                    gateway:
                      type: string
                    name:
                      type: string
                    subnet:
                      type: string
                  required:
                  - name
                  - subnet
                  type: object
                type: array
              providerNetType:
                type: string
              routes:
                items:
                  properties:
                    dst:
                      type: string
                    gw:
                      type: string
                  required:
                  - dst
                  type: object
                type: array
              vlan:
                properties:
                  logicalInterfaceName:
                    type: string
                  nodeLabelList:
                    items:
                      type: string
                    type: array
                  providerInterfaceName:
                    type: string
                  vlanId:
                    type: string
                  vlanNodeSelector:
                    type: string
                required:
                - providerInterfaceName
                - vlanId
                - vlanNodeSelector
                type: object
            required:
            - cniType
            - ipv4Subnets
            - providerNetType
            type: object
          status:
            description: ProviderNetworkStatus defines the observed state of ProviderNetwork
            properties:
              state:
                description: 'INSERT ADDITIONAL STATUS FIELD - define observed state
                  of cluster Important: Run "operator-sdk generate k8s" to regenerate
                  code after modifying this file Add custom validation using kubebuilder
                  tags: https://book-v1.book.kubebuilder.io/beyond_basics/generating_crd.html'
                type: string
            required:
            - state
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s-nfn-sa
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: k8s-nfn-cr
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - pods/status
  - services
  - endpoints
  - persistentvolumeclaims
  - events
  - configmaps
  - secrets
  - nodes
  - namespaces
  verbs:
  - '*'
- apiGroups:
  - apps
  resources:
  - deployments
  - daemonsets
  - replicasets
  - statefulsets
  verbs:
  - '*'
- apiGroups:
  - monitoring.coreos.com
  resources:
  - servicemonitors
  verbs:
  - get
  - create
- apiGroups:
  - apps
  resourceNames:
  - nfn-operator
  resources:
  - deployments/finalizers
  verbs:
  - update
- apiGroups:
  - k8s.plugin.opnfv.org
  resources:
  - '*'
  - providernetworks
  verbs:
  - '*'
- apiGroups:
  - networking.k8s.io
  resources:
  - networkpolicies
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - cert-manager.io
  resources:
  - certificates
  verbs:
  - get
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8s-nfn-crb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: k8s-nfn-cr
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:serviceaccounts
---
apiVersion: v1
data:
  ovn_gatewayip: 10.151.142.1/18
  ovn_subnet: 10.151.142.0/18
kind: ConfigMap
metadata:
  name: ovn-controller-network
  namespace: kube-system
---
apiVersion: v1
data:
  20-network.conf: |
    {
      "name": "ovn4nfv-k8s-plugin",
      "type": "ovn4nfvk8s-cni",
      "cniVersion": "0.3.1"
    }
  ovn4nfv_k8s.conf: |
    [logging]
    loglevel=5
    logfile=/var/log/openvswitch/ovn4k8s.log

    [cni]
    conf-dir=/etc/cni/net.d
    plugin=ovn4nfvk8s-cni

    [kubernetes]
    kubeconfig=/etc/cni/net.d/ovn4nfv-k8s.d/ovn4nfv-k8s.kubeconfig
    namespace=kube-system
kind: ConfigMap
metadata:
  labels:
    app: ovn4nfv
  name: ovn4nfv-cni-config
  namespace: kube-system
---
apiVersion: v1
kind: Service
metadata:
  name: nfn-operator
  namespace: kube-system
spec:
  ports:
  - port: 50000
    protocol: TCP
    targetPort: 50000
  selector:
    name: nfn-operator
  type: NodePort
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfn-operator
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      name: nfn-operator
  template:
    metadata:
      labels:
        name: nfn-operator
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: ovn4nfv-k8s-plugin
                operator: In
                values:
                - ovn-control-plane
      containers:
      - command:
        - /usr/local/bin/entrypoint
        - operator
        env:
        - name: OVN_SUBNET
          valueFrom:
            configMapKeyRef:
              key: ovn_subnet
              name: ovn-controller-network
        - name: OVN_GATEWAYIP
          valueFrom:
            configMapKeyRef:
              key: ovn_gatewayip
              name: ovn-controller-network
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: OPERATOR_NAME
          value: nfn-operator
        image: docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v6.0.0
        imagePullPolicy: IfNotPresent
        name: nfn-operator
        ports:
        - containerPort: 50000
          protocol: TCP
        volumeMounts:
        - mountPath: /opt/ovn-certs
          name: cert
          readOnly: true
      hostNetwork: true
      serviceAccountName: k8s-nfn-sa
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
        operator: Exists
      volumes:
      - name: cert
        secret:
          defaultMode: 420
          secretName: nodus-ovn-cert
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: nfn-agent
  name: nfn-agent
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: nfn-agent
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/nfn-agent: unconfined
      labels:
        app: nfn-agent
    spec:
      containers:
      - command:
        - /usr/local/bin/entrypoint
        - agent
        env:
        - name: OVN_SUBNET
          valueFrom:
            configMapKeyRef:
              key: ovn_subnet
              name: ovn-controller-network
        - name: OVN_GATEWAYIP
          valueFrom:
            configMapKeyRef:
              key: ovn_gatewayip
              name: ovn-controller-network
        - name: NFN_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v6.0.0
        imagePullPolicy: IfNotPresent
        name: nfn-agent
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 50Mi
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - SYS_ADMIN
            - SYS_PTRACE
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/run/dbus/
          name: host-var-run-dbus
          readOnly: true
        - mountPath: /run/openvswitch
          name: host-run-ovs
        - mountPath: /var/run/openvswitch
          name: host-var-run-ovs
        - mountPath: /var/run
          name: host-var-run
        - mountPath: /host/proc
          name: host-proc
        - mountPath: /host/sys
          name: host-sys
        - mountPath: /var/run/ovn4nfv-k8s-plugin
          name: host-var-cniserver-socket-dir
        - mountPath: /opt/ovn-certs
          name: cert
          readOnly: true
      hostNetwork: true
      hostPID: true
      nodeSelector:
        beta.kubernetes.io/arch: amd64
      serviceAccountName: k8s-nfn-sa
      tolerations:
      - effect: NoSchedule
        operator: Exists
      volumes:
      - hostPath:
          path: /run/openvswitch
        name: host-run-ovs
      - hostPath:
          path: /var/run/openvswitch
        name: host-var-run-ovs
      - hostPath:
          path: /var/run/dbus
        name: host-var-run-dbus
      - hostPath:
          path: /var/run/ovn4nfv-k8s-plugin
        name: host-var-cniserver-socket-dir
      - hostPath:
          path: /var/run
        name: host-var-run
      - hostPath:
          path: /proc
        name: host-proc
      - hostPath:
          path: /sys
        name: host-sys
      - name: cert
        secret:
          defaultMode: 420
          secretName: nodus-ovn-cert
  updateStrategy:
    type: RollingUpdate
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: ovn4nfv
  name: ovn4nfv-cni
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: ovn4nfv
  template:
    metadata:
      labels:
        app: ovn4nfv
    spec:
      containers:
      - command:
        - /usr/local/bin/entrypoint
        - cni
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v6.0.0
        imagePullPolicy: IfNotPresent
        name: ovn4nfv
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 50Mi
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
        volumeMounts:
        - mountPath: /host/etc/cni/net.d
          name: cni
        - mountPath: /host/opt/cni/bin
          name: cnibin
        - mountPath: /host/etc/openvswitch
          name: cniconf
        - mountPath: /tmp/ovn4nfv-conf
          name: ovn4nfv-cfg
        - mountPath: /tmp/ovn4nfv-cni
          name: ovn4nfv-cni-net-conf
      hostNetwork: true
      nodeSelector:
        beta.kubernetes.io/arch: amd64
      serviceAccountName: k8s-nfn-sa
      tolerations:
      - effect: NoSchedule
        operator: Exists
      volumes:
      - hostPath:
          path: /etc/cni/net.d
        name: cni
      - hostPath:
          path: /opt/cni/bin
        name: cnibin
      - hostPath:
          path: /etc/openvswitch
        name: cniconf
      - configMap:
          items:
          - key: ovn4nfv_k8s.conf
            path: ovn4nfv_k8s.conf
          name: ovn4nfv-cni-config
        name: ovn4nfv-cfg
      - configMap:
          items:
          - key: 20-network.conf
            path: 20-network.conf
          name: ovn4nfv-cni-config
        name: ovn4nfv-cni-net-conf
  updateStrategy:
    type: RollingUpdate
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: nodus-cert
  namespace: kube-system
spec:
  duration: 17520h
  ipAddresses:
  - 1.1.1.1
  isCA: false
  issuerRef:
    kind: Issuer
    name: nodus-issuer
  secretName: nodus-cert
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: nodus-cni-cert
  namespace: kube-system
spec:
  commonName: dummy
  dnsNames:
  - dummy
  duration: 17520h
  isCA: false
  issuerRef:
    kind: Issuer
    name: nodus-issuer
  secretName: nodus-cni-cert
